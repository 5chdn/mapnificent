<html>
<head><title>Mapnificent Worker</title>
</head>
<body>
    <script type="text/javascript" charset="utf-8">
        var workers = {};
        var workerCounter = 0;

        function receiveMessage(event){
            var data = JSON.parse(event.data);
            var index = data.index;
            if(workers[index] === undefined){
                workers[index] = {"worker": new Worker("/static/js/worker.js"),
                    "source": event.source, "origin": event.origin
                };
                workers[index].worker.onmessage = function(event){
                    workers[index].source.postMessage(JSON.stringify({"index": index, "command": "onmessage", "payload": event.data}), workers[index].origin);  
                };
                workers[index].worker.onerror = function(event){
                    workers[index].source.postMessage(JSON.stringify({"index": index, "command": "onerror", "payload": event.data}), workers[index].origin);  
                };
            }
            if(data.command === "postMessage"){
                workers[index].worker.postMessage(data.payload);
            } else if (data.command === "terminate"){
                workers[index].worker.terminate();
                delete workers[index]["worker"];
                delete workers[index];
            }
            return;
        }
        if(typeof window.addEventListener !== 'undefined') { 
            window.addEventListener('message', receiveMessage, false); 
        } else if(typeof window.attachEvent != 'undefined') { 
            window.attachEvent('onmessage', receiveMessage); 
        }
    </script>
</body>
</html>    